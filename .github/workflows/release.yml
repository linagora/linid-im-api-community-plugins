name: Release plugins

on:
  push:
    branches: [main]

jobs:
  detect-plugins:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get modified plugins
        id: set-matrix
        run: |
          echo "üîç Detecting modified plugins..."
          PLUGINS=$(git log -1 --pretty=format:%B \
            | grep -oP '(?<=\().+?(?=\))' \
            | sort -u \
            | grep -v '^template-plugin$' \
            | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "matrix=${PLUGINS}"
          echo "matrix=${PLUGINS}" >> $GITHUB_OUTPUT

  release:
    needs: detect-plugins
    runs-on: ubuntu-latest
    if: needs.detect-plugins.outputs.matrix != '[]'
    strategy:
      matrix:
        plugin: ${{ fromJson(needs.detect-plugins.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Import GPG Key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --no-tty --import
          echo "no-tty" >> ~/.gnupg/gpg.conf
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Release new version
        working-directory: ${{ matrix.plugin }}
        run: mvn io.github.zorin95670:semantic-version:0.4.0:release -DtagPrefix=${{ matrix.plugin }}-v -Dscope=${{matrix.plugin }}

      - name: Build and publish to Maven Central
        working-directory: plugins/${{ matrix.plugin }}
        run: mvn clean deploy -DskipTests -s .github/maven-settings.xml
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSWORD }}

      - name: Push new tag and release commit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/linagora/linid-im-api-community-plugins.git
          git push origin main
          git push origin --tags